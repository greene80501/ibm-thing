{% extends "base.html" %}

{% block title %}Theme Clustering{% endblock %}
{% block header %}Theme Clustering Engine{% endblock %}
{% block subtitle %}Discover hidden patterns in your audience conversations{% endblock %}

{% block content %}
<!-- Input Section -->
<div class="card p-8 mb-8">
    <div class="flex items-center mb-6">
        <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center mr-4">
            <i class="fas fa-project-diagram text-purple-400 text-xl"></i>
        </div>
        <div>
            <h3 class="text-2xl font-semibold text-white">Thematic Analysis</h3>
            <p class="text-slate-400">Uncover key themes and emerging patterns in video comments</p>
        </div>
    </div>
    
    <form id="clustering-form" class="api-form">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label for="video-url-cluster" class="block text-lg font-medium text-white mb-3">YouTube Video URL</label>
                <div class="relative">
                    <input type="url" id="video-url-cluster" 
                           class="w-full p-4 pl-12 bg-slate-800/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" 
                           placeholder="https://www.youtube.com/watch?v=..." required>
                    <i class="fas fa-link absolute left-4 top-5 text-slate-400"></i>
                </div>
                <p class="text-slate-500 text-sm mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    We'll analyze up to 80 comments to identify thematic clusters and outliers
                </p>
            </div>
            <div class="flex items-end">
                <button type="submit" 
                        class="btn-primary px-8 py-4 rounded-xl text-white font-semibold hover:shadow-lg transform transition-all duration-200 flex items-center">
                    <span id="cluster-button-text">Find Themes</span>
                    <i id="cluster-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                    <i class="fas fa-search ml-2" id="cluster-icon"></i>
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Results Section -->
<div id="clustering-results" class="hidden">
    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-layer-group text-purple-400 text-xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-1" id="dominant-themes-count">0</h3>
            <p class="text-slate-400 text-sm">Dominant Themes</p>
        </div>
        
        <div class="card p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-star text-yellow-400 text-xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-1" id="emerging-themes-count">0</h3>
            <p class="text-slate-400 text-sm">Emerging Themes</p>
        </div>
        
        <div class="card p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-comments text-blue-400 text-xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-1" id="total-analyzed">0</h3>
            <p class="text-slate-400 text-sm">Comments Analyzed</p>
        </div>
    </div>
    
    <!-- Dominant Themes -->
    <div class="mb-10">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-2xl font-bold text-white mb-2">Dominant Themes</h3>
                <p class="text-slate-400">Major conversation topics with significant engagement</p>
            </div>
        </div>
        <div id="clusters-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cluster cards will be inserted here -->
        </div>
    </div>
    
    <!-- Outliers & Emerging Themes -->
    <div>
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-2xl font-bold text-white mb-2">Outliers & Emerging Themes</h3>
                <p class="text-slate-400">Unique perspectives and potential trending topics</p>
            </div>
        </div>
        <div id="outliers-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Outlier cards will be inserted here -->
        </div>
    </div>
    
    <!-- Insights Panel -->
    <div class="mt-10 card p-6">
        <h3 class="text-xl font-semibold text-white mb-4">
            <i class="fas fa-brain text-blue-400 mr-2"></i>
            AI Insights
        </h3>
        <div id="theme-insights" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
                <h4 class="text-lg font-medium text-white mb-3">Key Insights</h4>
                <div id="key-insights" class="space-y-3 text-sm text-slate-300"></div>
            </div>
            <div>
                <h4 class="text-lg font-medium text-white mb-3">Content Recommendations</h4>
                <div id="content-recommendations" class="space-y-3 text-sm text-slate-300"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('clustering-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const videoUrl = document.getElementById('video-url-cluster').value;
    const resultsDiv = document.getElementById('clustering-results');
    const clusterButton = document.querySelector('#clustering-form button[type="submit"]');
    
    resultsDiv.classList.add('hidden');
    clusterButton.disabled = true;
    clusterButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...`;
    
    try {
        const response = await fetch('/api/cluster-themes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_url: videoUrl })
        });
        
        if (!response.ok) throw new Error('Theme clustering failed.');
        
        const data = await response.json();
        
        resultsDiv.classList.remove('hidden');
        updateStatistics(data);
        renderClusters(data.clusters);
        renderOutliers(data.outliers);
        generateInsights(data);
        
    } catch (error) {
        alert('Error: ' + error.message);
    } finally {
        clusterButton.disabled = false;
        clusterButton.innerHTML = `<span id="cluster-button-text">Find Themes</span><i class="fas fa-search ml-2" id="cluster-icon"></i>`;
    }
});

function updateStatistics(data) {
    const dominantCount = data.clusters ? data.clusters.length : 0;
    const emergingCount = data.outliers ? data.outliers.length : 0;
    const totalComments = (data.clusters || []).reduce((sum, c) => sum + (c.comment_ids?.length || 0), 0) +
                         (data.outliers || []).reduce((sum, o) => sum + (o.comment_ids?.length || 0), 0);
    
    document.getElementById('dominant-themes-count').textContent = dominantCount;
    document.getElementById('emerging-themes-count').textContent = emergingCount;
    document.getElementById('total-analyzed').textContent = totalComments;
}

function renderClusters(clusters) {
    const container = document.getElementById('clusters-container');
    container.innerHTML = '';
    if (!clusters || clusters.length === 0) return;

    const gradients = ['from-blue-500/20 to-cyan-500/20', 'from-purple-500/20 to-pink-500/20', 'from-green-500/20 to-emerald-500/20'];
    clusters.forEach((cluster, index) => {
        const card = document.createElement('div');
        card.className = `card p-6 cursor-pointer hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 bg-gradient-to-br ${gradients[index % gradients.length]}`;
        card.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center"><i class="fas fa-layer-group text-white text-xl"></i></div>
                <div class="px-2 py-1 rounded-full bg-white/20 text-white text-xs font-semibold">${cluster.comment_ids?.length || 0} comments</div>
            </div>
            <h4 class="text-lg font-bold text-white mb-3">${cluster.summary}</h4>`;
        container.appendChild(card);
    });
}

function renderOutliers(outliers) {
    const container = document.getElementById('outliers-container');
    container.innerHTML = '';
    if (!outliers || outliers.length === 0) return;

    outliers.forEach((outlier) => {
        const card = document.createElement('div');
        card.className = `card p-6 cursor-pointer hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 bg-gradient-to-br from-yellow-500/10 to-orange-500/10 border-yellow-500/30`;
        card.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center"><i class="fas fa-star text-yellow-400 text-xl"></i></div>
                <div class="px-2 py-1 rounded-full bg-yellow-500/20 text-yellow-200 text-xs font-semibold">${outlier.comment_ids?.length || 0} comments</div>
            </div>
            <h4 class="text-lg font-bold text-white mb-3">${outlier.summary}</h4>`;
        container.appendChild(card);
    });
}

function generateInsights(data) {
    const insightsContainer = document.getElementById('key-insights');
    const recsContainer = document.getElementById('content-recommendations');
    const clusters = data.clusters || [];
    const outliers = data.outliers || [];

    let insights = [];
    let recommendations = [];

    // General Insights
    if (clusters.length > 3) insights.push('High theme diversity suggests your content appeals to varied interests.');
    else insights.push('The discussion is focused on a few key topics, indicating a clear message.');
    if (outliers.length > 0) insights.push(`Discovered ${outliers.length} emerging theme(s) that could be future content opportunities.`);

    // Specific Recommendations based on themes
    if (clusters.length > 0) {
        const topTheme = clusters.reduce((prev, current) => ((prev.comment_ids?.length || 0) > (current.comment_ids?.length || 0)) ? prev : current);
        recommendations.push(`Your most dominant theme is "<strong>${topTheme.summary}</strong>". Create a dedicated follow-up video on this topic.`);
    }
    
    const requestTheme = clusters.find(c => c.summary.toLowerCase().includes('request'));
    if (requestTheme) {
        recommendations.push(`The "<strong>Topic Request</strong>" theme is strong. Consider making a "Q&A" or "Answering Your Comments" video.`);
    }
    
    const qualityTheme = clusters.find(c => c.summary.toLowerCase().includes('quality'));
    if (qualityTheme) {
        recommendations.push(`Viewers are discussing "<strong>Video Quality</strong>". This is a great opportunity to create a "Behind-the-Scenes" or "My Gear" video.`);
    }

    if (outliers.length > 0) {
        recommendations.push(`Monitor the outlier theme "<strong>${outliers[0].summary}</strong>". If it grows, it could be a viral topic.`);
    }

    if(recommendations.length == 0) recommendations.push('Engage with comments in all themes to foster community.');

    insightsContainer.innerHTML = insights.map(i => `<p class="flex items-start"><i class="fas fa-check-circle text-green-400 mr-2 mt-1"></i><span>${i}</span></p>`).join('');
    recsContainer.innerHTML = recommendations.map(r => `<p class="flex items-start"><i class="fas fa-lightbulb text-yellow-400 mr-2 mt-1"></i><span>${r}</span></p>`).join('');
}
</script>
{% endblock %}