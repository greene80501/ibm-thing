{% extends "base.html" %}

{% block title %}Theme Clustering{% endblock %}
{% block header %}Theme Clustering Engine{% endblock %}
{% block subtitle %}Discover hidden patterns in your audience conversations{% endblock %}

{% block content %}
<!-- Input Section -->
<div class="card p-8 mb-8">
    <div class="flex items-center mb-6">
        <div class="w-12 h-12 rounded-xl bg-purple-500/20 flex items-center justify-center mr-4">
            <i class="fas fa-project-diagram text-purple-400 text-xl"></i>
        </div>
        <div>
            <h3 class="text-2xl font-semibold text-white">Thematic Analysis</h3>
            <p class="text-slate-400">Uncover key themes and emerging patterns in video comments</p>
        </div>
    </div>
    
    <form id="clustering-form" class="api-form">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label for="video-url-cluster" class="block text-lg font-medium text-white mb-3">YouTube Video URL</label>
                <div class="relative">
                    <input type="url" id="video-url-cluster" 
                           class="w-full p-4 pl-12 bg-slate-800/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-all duration-200" 
                           placeholder="https://www.youtube.com/watch?v=..." required>
                    <i class="fas fa-link absolute left-4 top-5 text-slate-400"></i>
                </div>
                <p class="text-slate-500 text-sm mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    We'll analyze up to 80 comments to identify thematic clusters and outliers
                </p>
            </div>
            <div class="flex items-end">
                <button type="submit" 
                        class="btn-primary px-8 py-4 rounded-xl text-white font-semibold hover:shadow-lg transform transition-all duration-200 flex items-center">
                    <span id="cluster-button-text">Find Themes</span>
                    <i id="cluster-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                    <i class="fas fa-search ml-2" id="cluster-icon"></i>
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Results Section -->
<div id="clustering-results" class="hidden">
    <!-- Summary Stats -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="card p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-purple-500/20 flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-layer-group text-purple-400 text-xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-1" id="dominant-themes-count">0</h3>
            <p class="text-slate-400 text-sm">Dominant Themes</p>
        </div>
        
        <div class="card p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-star text-yellow-400 text-xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-1" id="emerging-themes-count">0</h3>
            <p class="text-slate-400 text-sm">Emerging Themes</p>
        </div>
        
        <div class="card p-6 text-center">
            <div class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center mx-auto mb-3">
                <i class="fas fa-comments text-blue-400 text-xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-1" id="total-analyzed">0</h3>
            <p class="text-slate-400 text-sm">Comments Analyzed</p>
        </div>
    </div>
    
    <!-- Dominant Themes -->
    <div class="mb-10">
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-2xl font-bold text-white mb-2">Dominant Themes</h3>
                <p class="text-slate-400">Major conversation topics with significant engagement</p>
            </div>
            <div class="flex space-x-2">
                <button class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400 hover:bg-purple-500/30 transition-colors duration-200" title="Export themes">
                    <i class="fas fa-download"></i>
                </button>
                <button class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 hover:bg-blue-500/30 transition-colors duration-200" title="View details">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
        <div id="clusters-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Cluster cards will be inserted here -->
        </div>
        <div id="no-clusters" class="hidden text-center py-12 text-slate-400">
            <i class="fas fa-search text-4xl mb-4 opacity-50"></i>
            <p class="text-lg mb-2">No dominant themes found</p>
            <p class="text-sm">Try analyzing a video with more varied comments</p>
        </div>
    </div>
    
    <!-- Outliers & Emerging Themes -->
    <div>
        <div class="flex items-center justify-between mb-6">
            <div>
                <h3 class="text-2xl font-bold text-white mb-2">Outliers & Emerging Themes</h3>
                <p class="text-slate-400">Unique perspectives and potential trending topics</p>
            </div>
            <div class="px-3 py-1 rounded-full bg-yellow-500/20 border border-yellow-500/30">
                <span class="text-yellow-300 text-sm font-medium">
                    <i class="fas fa-lightbulb mr-1"></i>
                    Worth Monitoring
                </span>
            </div>
        </div>
        <div id="outliers-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Outlier cards will be inserted here -->
        </div>
        <div id="no-outliers" class="hidden text-center py-12 text-slate-400">
            <i class="fas fa-filter text-4xl mb-4 opacity-50"></i>
            <p class="text-lg mb-2">No outliers detected</p>
            <p class="text-sm">All comments fit into dominant themes</p>
        </div>
    </div>
    
    <!-- Insights Panel -->
    <div class="mt-10 card p-6">
        <h3 class="text-xl font-semibold text-white mb-4">
            <i class="fas fa-brain text-blue-400 mr-2"></i>
            AI Insights
        </h3>
        <div id="theme-insights" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Key Insights -->
            <div>
                <h4 class="text-lg font-medium text-white mb-3">Key Insights</h4>
                <div id="key-insights" class="space-y-3 text-sm text-slate-300">
                    <p>Complete analysis to see key insights...</p>
                </div>
            </div>
            
            <!-- Recommendations -->
            <div>
                <h4 class="text-lg font-medium text-white mb-3">Content Recommendations</h4>
                <div id="content-recommendations" class="space-y-3 text-sm text-slate-300">
                    <p>Complete analysis to see recommendations...</p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.getElementById('clustering-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const videoUrl = document.getElementById('video-url-cluster').value;
    const resultsDiv = document.getElementById('clustering-results');
    const clusterButton = document.querySelector('#clustering-form button[type="submit"]');
    const buttonText = document.getElementById('cluster-button-text');
    const spinner = document.getElementById('cluster-spinner');
    const icon = document.getElementById('cluster-icon');
    
    // Reset state
    resultsDiv.classList.add('hidden');
    
    // Show loading state
    buttonText.textContent = 'Analyzing...';
    spinner.classList.remove('hidden');
    icon.classList.add('hidden');
    clusterButton.disabled = true;
    
    try {
        const response = await fetch('/api/cluster-themes', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_url: videoUrl })
        });
        
        if (!response.ok) {
            throw new Error('Theme clustering failed. Please check the URL and try again.');
        }
        
        const data = await response.json();
        
        // Display results
        resultsDiv.classList.remove('hidden');
        updateStatistics(data);
        renderClusters(data.clusters);
        renderOutliers(data.outliers);
        generateInsights(data);
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    } finally {
        // Restore button state
        buttonText.textContent = 'Find Themes';
        spinner.classList.add('hidden');
        icon.classList.remove('hidden');
        clusterButton.disabled = false;
    }
});

function updateStatistics(data) {
    const dominantCount = data.clusters ? data.clusters.length : 0;
    const emergingCount = data.outliers ? data.outliers.length : 0;
    const totalComments = (data.clusters || []).reduce((sum, cluster) => sum + cluster.comment_ids.length, 0) +
                         (data.outliers || []).reduce((sum, outlier) => sum + outlier.comment_ids.length, 0);
    
    document.getElementById('dominant-themes-count').textContent = dominantCount;
    document.getElementById('emerging-themes-count').textContent = emergingCount;
    document.getElementById('total-analyzed').textContent = totalComments;
    
    // Animate the numbers
    animateNumber('dominant-themes-count', dominantCount);
    animateNumber('emerging-themes-count', emergingCount);
    animateNumber('total-analyzed', totalComments);
}

function animateNumber(elementId, finalValue) {
    const element = document.getElementById(elementId);
    const duration = 1000;
    const start = performance.now();
    
    function update(currentTime) {
        const elapsed = currentTime - start;
        const progress = Math.min(elapsed / duration, 1);
        const currentValue = Math.floor(finalValue * progress);
        element.textContent = currentValue;
        
        if (progress < 1) {
            requestAnimationFrame(update);
        }
    }
    
    requestAnimationFrame(update);
}

function renderClusters(clusters) {
    const container = document.getElementById('clusters-container');
    const noClusterMsg = document.getElementById('no-clusters');
    
    if (!clusters || clusters.length === 0) {
        container.innerHTML = '';
        noClusterMsg.classList.remove('hidden');
        return;
    }
    
    noClusterMsg.classList.add('hidden');
    container.innerHTML = '';
    
    // Define gradient colors for different themes
    const gradients = [
        'from-blue-500/20 to-cyan-500/20 border-blue-500/30',
        'from-purple-500/20 to-pink-500/20 border-purple-500/30',
        'from-green-500/20 to-emerald-500/20 border-green-500/30',
        'from-orange-500/20 to-red-500/20 border-orange-500/30',
        'from-indigo-500/20 to-purple-500/20 border-indigo-500/30',
        'from-teal-500/20 to-blue-500/20 border-teal-500/30'
    ];
    
    clusters.forEach((cluster, index) => {
        const gradient = gradients[index % gradients.length];
        const card = document.createElement('div');
        card.className = `card p-6 cursor-pointer hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 bg-gradient-to-br ${gradient}`;
        
        const commentCount = cluster.comment_ids ? cluster.comment_ids.length : 0;
        const engagement = calculateEngagementLevel(commentCount);
        
        card.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-white/10 flex items-center justify-center">
                    <i class="fas fa-layer-group text-white text-xl"></i>
                </div>
                <div class="px-2 py-1 rounded-full bg-white/20 backdrop-blur-sm">
                    <span class="text-white text-xs font-semibold">${commentCount} comments</span>
                </div>
            </div>
            <h4 class="text-lg font-bold text-white mb-3 leading-tight">${cluster.summary}</h4>
            <div class="flex items-center justify-between text-sm">
                <span class="text-white/80">Engagement: ${engagement}</span>
                <div class="flex items-center text-white/60">
                    <i class="fas fa-chart-line mr-1"></i>
                    <span>Trending</span>
                </div>
            </div>
        `;
        
        // Add click handler for detailed view
        card.addEventListener('click', () => {
            showClusterDetails(cluster);
        });
        
        container.appendChild(card);
    });
}

function renderOutliers(outliers) {
    const container = document.getElementById('outliers-container');
    const noOutliersMsg = document.getElementById('no-outliers');
    
    if (!outliers || outliers.length === 0) {
        container.innerHTML = '';
        noOutliersMsg.classList.remove('hidden');
        return;
    }
    
    noOutliersMsg.classList.add('hidden');
    container.innerHTML = '';
    
    outliers.forEach((outlier, index) => {
        const card = document.createElement('div');
        card.className = `card p-6 cursor-pointer hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 bg-gradient-to-br from-yellow-500/10 to-orange-500/10 border-yellow-500/30`;
        
        const commentCount = outlier.comment_ids ? outlier.comment_ids.length : 0;
        
        card.innerHTML = `
            <div class="flex items-start justify-between mb-4">
                <div class="w-12 h-12 rounded-xl bg-yellow-500/20 flex items-center justify-center">
                    <i class="fas fa-star text-yellow-400 text-xl"></i>
                </div>
                <div class="px-2 py-1 rounded-full bg-yellow-500/20 backdrop-blur-sm border border-yellow-500/30">
                    <span class="text-yellow-200 text-xs font-semibold">${commentCount} comments</span>
                </div>
            </div>
            <h4 class="text-lg font-bold text-white mb-3 leading-tight">${outlier.summary}</h4>
            <div class="flex items-center justify-between text-sm">
                <span class="text-yellow-200">Potential: High</span>
                <div class="flex items-center text-yellow-300">
                    <i class="fas fa-lightbulb mr-1"></i>
                    <span>Monitor</span>
                </div>
            </div>
        `;
        
        // Add click handler for detailed view
        card.addEventListener('click', () => {
            showOutlierDetails(outlier);
        });
        
        container.appendChild(card);
    });
}

function calculateEngagementLevel(commentCount) {
    if (commentCount >= 10) return 'High';
    if (commentCount >= 5) return 'Medium';
    return 'Low';
}

function generateInsights(data) {
    const keyInsightsContainer = document.getElementById('key-insights');
    const recommendationsContainer = document.getElementById('content-recommendations');
    
    const clusterCount = data.clusters ? data.clusters.length : 0;
    const outlierCount = data.outliers ? data.outliers.length : 0;
    const totalComments = (data.clusters || []).reduce((sum, cluster) => sum + cluster.comment_ids.length, 0) +
                         (data.outliers || []).reduce((sum, outlier) => sum + outlier.comment_ids.length, 0);
    
    // Generate key insights
    let insights = [];
    
    if (clusterCount > 5) {
        insights.push('📊 High theme diversity detected - your content appeals to varied interests.');
    } else if (clusterCount < 3) {
        insights.push('🎯 Focused discussion - your audience is aligned on key topics.');
    } else {
        insights.push('⚖️ Balanced theme distribution - good mix of discussion topics.');
    }
    
    if (outlierCount > clusterCount * 0.3) {
        insights.push('💡 High outlier ratio suggests emerging trends worth exploring.');
    }
    
    if (totalComments > 50) {
        insights.push('🚀 Strong engagement levels with diverse conversation patterns.');
    }
    
    insights.push(`🔢 Analyzed ${totalComments} comments across ${clusterCount + outlierCount} distinct themes.`);
    
    // Generate content recommendations
    let recommendations = [];
    
    if (clusterCount > 0) {
        recommendations.push('📝 Create follow-up content addressing your dominant themes.');
        recommendations.push('🎥 Consider making dedicated videos for your top 3 themes.');
    }
    
    if (outlierCount > 0) {
        recommendations.push('🔍 Monitor outlier themes for potential viral content opportunities.');
        recommendations.push('💬 Engage directly with unique perspectives to build community.');
    }
    
    if (clusterCount > 3) {
        recommendations.push('📋 Develop a content calendar covering your main theme categories.');
    }
    
    recommendations.push('📈 Track theme evolution over time to spot trending topics.');
    
    // Update UI
    keyInsightsContainer.innerHTML = insights.map(insight => `<p>${insight}</p>`).join('');
    recommendationsContainer.innerHTML = recommendations.map(rec => `<p>${rec}</p>`).join('');
}

function showClusterDetails(cluster) {
    // Create modal or detailed view for cluster
    const modal = createModal();
    modal.innerHTML = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Theme Details</h3>
                <button class="text-slate-400 hover:text-white" onclick="closeModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-4">
                <h4 class="text-lg font-semibold text-blue-400 mb-2">${cluster.summary}</h4>
                <p class="text-slate-300">Comments: ${cluster.comment_ids ? cluster.comment_ids.length : 0}</p>
            </div>
            <div class="mt-4">
                <h5 class="text-white font-medium mb-2">Analysis:</h5>
                <p class="text-slate-400 text-sm">This theme represents a significant discussion point among your audience. Consider creating dedicated content around this topic.</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function showOutlierDetails(outlier) {
    // Create modal or detailed view for outlier
    const modal = createModal();
    modal.innerHTML = `
        <div class="p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-white">Emerging Theme</h3>
                <button class="text-slate-400 hover:text-white" onclick="closeModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div class="mb-4">
                <h4 class="text-lg font-semibold text-yellow-400 mb-2">${outlier.summary}</h4>
                <p class="text-slate-300">Comments: ${outlier.comment_ids ? outlier.comment_ids.length : 0}</p>
            </div>
            <div class="mt-4">
                <h5 class="text-white font-medium mb-2">Potential:</h5>
                <p class="text-slate-400 text-sm">This emerging theme shows potential for future content. Monitor its development and consider addressing it in upcoming videos.</p>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}

function createModal() {
    const modal = document.createElement('div');
    modal.className = 'fixed inset-0 bg-slate-900/80 backdrop-blur-sm flex items-center justify-center z-50';
    modal.id = 'theme-modal';
    
    const content = document.createElement('div');
    content.className = 'bg-slate-800 rounded-xl max-w-md w-full mx-4 border border-slate-600';
    
    modal.appendChild(content);
    return content;
}

function closeModal() {
    const modal = document.getElementById('theme-modal');
    if (modal) {
        modal.remove();
    }
}

// Close modal on outside click
document.addEventListener('click', function(e) {
    const modal = document.getElementById('theme-modal');
    if (modal && e.target === modal.parentElement) {
        closeModal();
    }
});

// Close modal on escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeModal();
    }
});
</script>
{% endblock %}