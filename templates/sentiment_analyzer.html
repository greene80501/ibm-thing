{% extends "base.html" %}

{% block title %}Sentiment Analyzer{% endblock %}
{% block header %}Sentiment Analyzer{% endblock %}
{% block subtitle %}Discover the emotional pulse of your audience{% endblock %}

{% block content %}
<!-- Input Section -->
<div class="card p-8 mb-8">
    <div class="flex items-center mb-6">
        <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center mr-4">
            <i class="fas fa-chart-pie text-blue-400 text-xl"></i>
        </div>
        <div>
            <h3 class="text-2xl font-semibold text-white">Video Analysis</h3>
            <p class="text-slate-400">Enter a YouTube URL to analyze comment sentiment and emotions</p>
        </div>
    </div>
    
    <form id="sentiment-form" class="api-form">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label for="video-url" class="block text-lg font-medium text-white mb-3">YouTube Video URL</label>
                <div class="relative">
                    <input type="url" id="video-url" 
                           class="w-full p-4 pl-12 bg-slate-800/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all duration-200" 
                           placeholder="https://www.youtube.com/watch?v=..." required>
                    <i class="fas fa-link absolute left-4 top-5 text-slate-400"></i>
                </div>
                <p class="text-slate-500 text-sm mt-2">
                    <i class="fas fa-info-circle mr-1"></i>
                    We'll analyze up to 40 recent comments for sentiment and emotional patterns
                </p>
            </div>
            <div class="flex items-end">
                <button type="submit" 
                        class="btn-primary px-8 py-4 rounded-xl text-white font-semibold hover:shadow-lg transform transition-all duration-200 flex items-center">
                    <span id="analyze-button-text">Analyze Sentiment</span>
                    <i id="analyze-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                    <i class="fas fa-search ml-2" id="analyze-icon"></i>
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Results Section -->
<div id="results" class="hidden">
    <!-- Alert Banner -->
    <div id="alert-banner" class="hidden mb-6 p-4 rounded-xl border-l-4 border-red-500 bg-red-500/10 animate-slide-up" role="alert">
        <div class="flex items-center">
            <i class="fas fa-exclamation-triangle text-red-400 mr-3"></i>
            <div>
                <p class="text-red-300 font-semibold">Attention Required</p>
                <p class="text-red-200 text-sm" id="alert-message"></p>
            </div>
        </div>
    </div>
    
    <!-- Charts Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <!-- Sentiment Chart -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-semibold text-white">Sentiment Breakdown</h3>
                    <p class="text-slate-400 text-sm">Overall emotional tone of comments</p>
                </div>
                <div class="w-10 h-10 rounded-lg bg-green-500/20 flex items-center justify-center">
                    <i class="fas fa-heart text-green-400"></i>
                </div>
            </div>
            <div class="relative">
                <canvas id="sentimentChart" class="max-w-full"></canvas>
            </div>
            <div id="sentiment-summary" class="mt-4 p-4 rounded-lg bg-slate-700/30 border border-slate-600/30">
                <p class="text-slate-300 text-sm" id="sentiment-description">Analysis will appear here...</p>
            </div>
        </div>
        
        <!-- Emotion Chart -->
        <div class="card p-6">
            <div class="flex items-center justify-between mb-6">
                <div>
                    <h3 class="text-xl font-semibold text-white">Emotion Analysis</h3>
                    <p class="text-slate-400 text-sm">Detailed emotional patterns detected</p>
                </div>
                <div class="w-10 h-10 rounded-lg bg-purple-500/20 flex items-center justify-center">
                    <i class="fas fa-brain text-purple-400"></i>
                </div>
            </div>
            <div class="relative">
                <canvas id="emotionChart" class="max-w-full"></canvas>
            </div>
            <div id="emotion-summary" class="mt-4 p-4 rounded-lg bg-slate-700/30 border border-slate-600/30">
                <p class="text-slate-300 text-sm" id="emotion-description">Analysis will appear here...</p>
            </div>
        </div>
    </div>
    
    <!-- Detailed Insights -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Key Metrics -->
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Key Metrics</h3>
            <div class="space-y-4">
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Total Comments</span>
                    <span class="text-white font-semibold" id="total-comments">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Engagement Score</span>
                    <span class="text-green-400 font-semibold" id="engagement-score">-</span>
                </div>
                <div class="flex justify-between items-center">
                    <span class="text-slate-400">Sentiment Score</span>
                    <span class="text-blue-400 font-semibold" id="sentiment-score">-</span>
                </div>
            </div>
        </div>
        
        <!-- Recommendations -->
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-white mb-4">
                <i class="fas fa-lightbulb text-yellow-400 mr-2"></i>
                Recommendations
            </h3>
            <div id="recommendations" class="space-y-3 text-sm text-slate-300">
                <p>Complete analysis to see recommendations</p>
            </div>
        </div>
        
        <!-- Export Options -->
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-white mb-4">Export & Share</h3>
            <div class="space-y-3">
                <button class="w-full p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-blue-300 hover:bg-blue-500/20 hover:border-blue-500/50 transition-all duration-200 text-left disabled:opacity-50" disabled id="export-pdf">
                    <i class="fas fa-file-pdf mr-3"></i>
                    Export PDF Report
                </button>
                <button class="w-full p-3 rounded-lg bg-green-500/10 border border-green-500/30 text-green-300 hover:bg-green-500/20 hover:border-green-500/50 transition-all duration-200 text-left disabled:opacity-50" disabled id="export-csv">
                    <i class="fas fa-file-csv mr-3"></i>
                    Export CSV Data
                </button>
                <button class="w-full p-3 rounded-lg bg-purple-500/10 border border-purple-500/30 text-purple-300 hover:bg-purple-500/20 hover:border-purple-500/50 transition-all duration-200 text-left disabled:opacity-50" disabled id="share-results">
                    <i class="fas fa-share mr-3"></i>
                    Share Results
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sentimentChartInstance, emotionChartInstance;

// Chart.js default configuration for dark theme
Chart.defaults.color = '#94a3b8';
Chart.defaults.borderColor = 'rgba(59, 130, 246, 0.2)';
Chart.defaults.backgroundColor = 'rgba(59, 130, 246, 0.1)';

document.getElementById('sentiment-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const videoUrl = document.getElementById('video-url').value;
    const resultsDiv = document.getElementById('results');
    const analyzeButton = document.querySelector('#sentiment-form button[type="submit"]');
    const buttonText = document.getElementById('analyze-button-text');
    const spinner = document.getElementById('analyze-spinner');
    const icon = document.getElementById('analyze-icon');
    
    // Reset state
    resultsDiv.classList.add('hidden');
    
    // Show loading state
    buttonText.textContent = 'Analyzing...';
    spinner.classList.remove('hidden');
    icon.classList.add('hidden');
    analyzeButton.disabled = true;
    
    try {
        const response = await fetch('/api/analyze-sentiment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_url: videoUrl })
        });
        
        if (!response.ok) {
            throw new Error('Analysis failed. Please check the URL and try again.');
        }
        
        const data = await response.json();
        
        // Show alert if present
        const alertBanner = document.getElementById('alert-banner');
        const alertMessage = document.getElementById('alert-message');
        if (data.alert) {
            alertMessage.textContent = data.alert;
            alertBanner.classList.remove('hidden');
        } else {
            alertBanner.classList.add('hidden');
        }
        
        // Display results
        resultsDiv.classList.remove('hidden');
        renderSentimentChart(data.sentiment_data);
        renderEmotionChart(data.emotion_data);
        updateMetrics(data);
        generateRecommendations(data);
        
        // Enable export buttons
        document.getElementById('export-pdf').disabled = false;
        document.getElementById('export-csv').disabled = false;
        document.getElementById('share-results').disabled = false;
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    } finally {
        // Restore button state
        buttonText.textContent = 'Analyze Sentiment';
        spinner.classList.add('hidden');
        icon.classList.remove('hidden');
        analyzeButton.disabled = false;
    }
});

function renderSentimentChart(data) {
    const ctx = document.getElementById('sentimentChart').getContext('2d');
    if (sentimentChartInstance) sentimentChartInstance.destroy();
    
    const total = data.positive + data.neutral + data.negative;
    const positivePercent = ((data.positive / total) * 100).toFixed(1);
    const neutralPercent = ((data.neutral / total) * 100).toFixed(1);
    const negativePercent = ((data.negative / total) * 100).toFixed(1);
    
    sentimentChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Positive', 'Neutral', 'Negative'],
            datasets: [{
                data: [data.positive, data.neutral, data.negative],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(156, 163, 175, 0.8)',
                    'rgba(248, 113, 113, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(156, 163, 175, 1)',
                    'rgba(248, 113, 113, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        color: '#e2e8f0'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleColor: '#e2e8f0',
                    bodyColor: '#e2e8f0',
                    borderColor: 'rgba(59, 130, 246, 0.5)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            const percent = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ${context.parsed} (${percent}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Update sentiment summary
    const sentimentDescription = document.getElementById('sentiment-description');
    if (data.positive >= data.negative + data.neutral) {
        sentimentDescription.innerHTML = `<i class="fas fa-smile text-green-400 mr-2"></i>Overall positive sentiment (${positivePercent}%). Your audience is responding well!`;
    } else if (data.negative > data.positive) {
        sentimentDescription.innerHTML = `<i class="fas fa-frown text-red-400 mr-2"></i>Negative sentiment detected (${negativePercent}%). Consider addressing audience concerns.`;
    } else {
        sentimentDescription.innerHTML = `<i class="fas fa-meh text-yellow-400 mr-2"></i>Mixed sentiment (${neutralPercent}% neutral). Room for improvement in engagement.`;
    }
}

function renderEmotionChart(data) {
    const ctx = document.getElementById('emotionChart').getContext('2d');
    if (emotionChartInstance) emotionChartInstance.destroy();
    
    const emotions = Object.keys(data).filter(key => data[key] > 0);
    const values = Object.values(data).filter(value => value > 0);
    
    if (emotions.length === 0) {
        document.getElementById('emotion-description').innerHTML = '<i class="fas fa-info-circle text-blue-400 mr-2"></i>No significant emotions detected in the comments.';
        return;
    }
    
    const emotionColors = {
        joy: 'rgba(251, 191, 36, 0.8)',
        anger: 'rgba(248, 113, 113, 0.8)',
        sadness: 'rgba(96, 165, 250, 0.8)',
        surprise: 'rgba(167, 139, 250, 0.8)',
        disgust: 'rgba(244, 114, 182, 0.8)',
        fear: 'rgba(156, 163, 175, 0.8)'
    };
    
    emotionChartInstance = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: emotions.map(e => e.charAt(0).toUpperCase() + e.slice(1)),
            datasets: [{
                data: values,
                backgroundColor: emotions.map(e => emotionColors[e] || 'rgba(156, 163, 175, 0.8)'),
                borderColor: emotions.map(e => emotionColors[e]?.replace('0.8', '1') || 'rgba(156, 163, 175, 1)'),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        padding: 20,
                        usePointStyle: true,
                        color: '#e2e8f0'
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.9)',
                    titleColor: '#e2e8f0',
                    bodyColor: '#e2e8f0',
                    borderColor: 'rgba(59, 130, 246, 0.5)',
                    borderWidth: 1
                }
            },
            scales: {
                r: {
                    beginAtZero: true,
                    ticks: {
                        color: '#64748b'
                    },
                    grid: {
                        color: 'rgba(59, 130, 246, 0.2)'
                    }
                }
            }
        }
    });
    
    // Update emotion summary
    const dominantEmotion = emotions[values.indexOf(Math.max(...values))];
    const emotionDescription = document.getElementById('emotion-description');
    emotionDescription.innerHTML = `<i class="fas fa-brain text-purple-400 mr-2"></i>Dominant emotion: <strong class="text-white">${dominantEmotion}</strong>. This suggests your content evokes strong ${dominantEmotion} responses.`;
}

function updateMetrics(data) {
    const total = data.sentiment_data.positive + data.sentiment_data.neutral + data.sentiment_data.negative;
    const positiveRatio = data.sentiment_data.positive / total;
    const sentimentScore = (positiveRatio * 100).toFixed(1);
    
    document.getElementById('total-comments').textContent = total;
    document.getElementById('engagement-score').textContent = (total * 0.12).toFixed(1) + '%';
    document.getElementById('sentiment-score').textContent = sentimentScore + '%';
}

function generateRecommendations(data) {
    const total = data.sentiment_data.positive + data.sentiment_data.neutral + data.sentiment_data.negative;
    const positiveRatio = data.sentiment_data.positive / total;
    const negativeRatio = data.sentiment_data.negative / total;
    
    const recommendations = document.getElementById('recommendations');
    let recs = [];
    
    if (positiveRatio > 0.7) {
        recs.push('✅ Great job! Your content is resonating well with your audience.');
        recs.push('💡 Consider creating similar content to maintain this positive response.');
    } else if (negativeRatio > 0.4) {
        recs.push('⚠️ High negative sentiment detected. Consider addressing common concerns.');
        recs.push('💬 Engage directly with negative comments to show you care.');
    } else {
        recs.push('📈 Mixed sentiment suggests room for improvement.');
        recs.push('🎯 Focus on topics that generate more positive responses.');
    }
    
    if (data.emotion_data.anger > data.emotion_data.joy) {
        recs.push('😤 Anger detected - consider more balanced or solution-focused content.');
    }
    
    if (recs.length === 0) {
        recs.push('📊 Analysis complete. Monitor trends over time for better insights.');
    }
    
    recommendations.innerHTML = recs.map(rec => `<p>${rec}</p>`).join('');
}
</script>
{% endblock %}