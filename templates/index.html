{% extends "base.html" %}

{% block title %}Analytics Dashboard - Alice Insight Suite{% endblock %}
{% block header %}Analytics Dashboard{% endblock %}
{% block subtitle %}Comprehensive insights and performance metrics{% endblock %}

{% block content %}
<!-- Channel Overview (if connected) -->
{% if user and user.channel_verified %}
<div class="card p-6 mb-8">
    <div class="flex items-center justify-between mb-6">
        <div class="flex items-center">
            <div class="w-12 h-12 rounded-xl overflow-hidden mr-4">
                {% if user.channel_thumbnail %}
                <img src="{{ user.channel_thumbnail }}" alt="Channel Thumbnail" class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full bg-red-500/20 flex items-center justify-center">
                    <i class="fab fa-youtube text-red-400 text-xl"></i>
                </div>
                {% endif %}
            </div>
            <div>
                <h3 class="text-xl font-semibold text-white">{{ user.channel_name }}</h3>
                <p class="text-slate-400 text-sm">
                    <i class="fas fa-check-circle text-green-400 mr-1"></i>
                    Connected Channel
                </p>
            </div>
        </div>
        <a href="/my-channel" class="px-4 py-2 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-colors text-sm">
            <i class="fab fa-youtube mr-2"></i>
            Manage Channel
        </a>
    </div>
    
    <!-- Channel Quick Stats -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="text-center p-3 rounded-lg bg-slate-700/30">
            <div class="text-lg font-bold text-white">{{ "{:,}".format(user.channel_subscriber_count) if user.channel_subscriber_count else '0' }}</div>
            <div class="text-slate-400 text-xs">Subscribers</div>
        </div>
        <div class="text-center p-3 rounded-lg bg-slate-700/30">
            <div class="text-lg font-bold text-white">{{ user_videos_count or '0' }}</div>
            <div class="text-slate-400 text-xs">Videos Imported</div>
        </div>
        <div class="text-center p-3 rounded-lg bg-slate-700/30">
            <div class="text-lg font-bold text-white">{{ user_transcripts_count or '0' }}</div>
            <div class="text-slate-400 text-xs">Transcripts</div>
        </div>
        <div class="text-center p-3 rounded-lg bg-slate-700/30">
            <div class="text-lg font-bold text-white">{{ "{:,}".format(user.channel_view_count) if user.channel_view_count else '0' }}</div>
            <div class="text-slate-400 text-xs">Total Views</div>
        </div>
    </div>
</div>
{% endif %}

<!-- Key Metrics Overview -->
<div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
    <div class="card p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm font-medium">Total Analyses</p>
                <p class="text-2xl font-semibold text-white mt-1" id="total-analyses">1,247</p>
                <p class="text-green-400 text-sm mt-1">
                    <i class="fas fa-arrow-up mr-1"></i>12% from last month
                </p>
            </div>
            <div class="w-12 h-12 bg-blue-600/10 rounded-lg flex items-center justify-center">
                <i class="fas fa-video text-blue-400"></i>
            </div>
        </div>
    </div>
    
    <div class="card p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm font-medium">Comments Processed</p>
                <p class="text-2xl font-semibold text-white mt-1" id="comments-processed">89.2K</p>
                <p class="text-green-400 text-sm mt-1">
                    <i class="fas fa-arrow-up mr-1"></i>8% from last month
                </p>
            </div>
            <div class="w-12 h-12 bg-green-600/10 rounded-lg flex items-center justify-center">
                <i class="fas fa-comments text-green-400"></i>
            </div>
        </div>
    </div>
    
    <div class="card p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm font-medium">Avg. Sentiment Score</p>
                <p class="text-2xl font-semibold text-white mt-1" id="avg-sentiment">73.2%</p>
                <p class="text-green-400 text-sm mt-1">
                    <i class="fas fa-arrow-up mr-1"></i>3% from last month
                </p>
            </div>
            <div class="w-12 h-12 bg-purple-600/10 rounded-lg flex items-center justify-center">
                <i class="fas fa-chart-line text-purple-400"></i>
            </div>
        </div>
    </div>
    
    <div class="card p-6">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-slate-400 text-sm font-medium">Scripts Generated</p>
                <p class="text-2xl font-semibold text-white mt-1" id="scripts-generated">156</p>
                <p class="text-green-400 text-sm mt-1">
                    <i class="fas fa-arrow-up mr-1"></i>24% from last month
                </p>
            </div>
            <div class="w-12 h-12 bg-orange-600/10 rounded-lg flex items-center justify-center">
                <i class="fas fa-edit text-orange-400"></i>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions for Channel Users -->
{% if user and user.channel_verified %}
<div class="card p-6 mb-8">
    <h3 class="text-xl font-semibold text-white mb-4">
        <i class="fas fa-bolt text-yellow-400 mr-2"></i>
        Quick Channel Actions
    </h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <button onclick="analyzeLatestVideo()" class="p-4 rounded-lg bg-blue-500/10 border border-blue-500/30 text-blue-300 hover:bg-blue-500/20 transition-colors text-left">
            <div class="flex items-center justify-between mb-2">
                <i class="fas fa-chart-pie text-2xl"></i>
                <span class="text-xs bg-blue-500/20 px-2 py-1 rounded-full">Smart</span>
            </div>
            <h4 class="font-semibold mb-1">Analyze Latest Video</h4>
            <p class="text-xs text-blue-200">Get sentiment analysis for your most recent upload</p>
        </button>
        
        <button onclick="generateContentIdeas()" class="p-4 rounded-lg bg-purple-500/10 border border-purple-500/30 text-purple-300 hover:bg-purple-500/20 transition-colors text-left">
            <div class="flex items-center justify-between mb-2">
                <i class="fas fa-lightbulb text-2xl"></i>
                <span class="text-xs bg-purple-500/20 px-2 py-1 rounded-full">AI</span>
            </div>
            <h4 class="font-semibold mb-1">Content Ideas</h4>
            <p class="text-xs text-purple-200">Generate new video ideas based on your channel</p>
        </button>
        
        <button onclick="createContentCalendar()" class="p-4 rounded-lg bg-emerald-500/10 border border-emerald-500/30 text-emerald-300 hover:bg-emerald-500/20 transition-colors text-left">
            <div class="flex items-center justify-between mb-2">
                <i class="fas fa-calendar-alt text-2xl"></i>
                <span class="text-xs bg-emerald-500/20 px-2 py-1 rounded-full">Auto</span>
            </div>
            <h4 class="font-semibold mb-1">Smart Calendar</h4>
            <p class="text-xs text-emerald-200">Auto-generate posting schedule with AI optimization</p>
        </button>
    </div>
</div>
{% endif %}

<!-- Analysis Tools -->
<div class="mb-8">
    <h3 class="text-xl font-semibold text-white mb-4">Analysis Tools</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
        <!-- Sentiment Analyzer -->
        <a href="/sentiment-analyzer" class="card p-6 hover:border-blue-500 transition-colors group">
            <div class="w-12 h-12 bg-blue-600/10 rounded-lg flex items-center justify-center mb-4 group-hover:bg-blue-600/20 transition-colors">
                <i class="fas fa-chart-pie text-blue-400 text-xl"></i>
            </div>
            <h4 class="text-lg font-semibold text-white mb-2">Sentiment Analysis</h4>
            <p class="text-slate-400 text-sm mb-4">Analyze audience emotions and sentiment patterns from video comments.</p>
            <div class="flex items-center text-blue-400 text-sm font-medium">
                <span>Launch Tool</span>
                <i class="fas fa-arrow-right ml-2"></i>
            </div>
        </a>
        
        <!-- Theme Clustering -->
        <a href="/theme-clustering" class="card p-6 hover:border-green-500 transition-colors group">
            <div class="w-12 h-12 bg-green-600/10 rounded-lg flex items-center justify-center mb-4 group-hover:bg-green-600/20 transition-colors">
                <i class="fas fa-project-diagram text-green-400 text-xl"></i>
            </div>
            <h4 class="text-lg font-semibold text-white mb-2">Theme Clustering</h4>
            <p class="text-slate-400 text-sm mb-4">Discover key discussion themes and trending topics in comments.</p>
            <div class="flex items-center text-green-400 text-sm font-medium">
                <span>Launch Tool</span>
                <i class="fas fa-arrow-right ml-2"></i>
            </div>
        </a>
        
        <!-- Competitor Dashboard -->
        <a href="/competitor-dashboard" class="card p-6 hover:border-purple-500 transition-colors group">
            <div class="w-12 h-12 bg-purple-600/10 rounded-lg flex items-center justify-center mb-4 group-hover:bg-purple-600/20 transition-colors">
                <i class="fas fa-tachometer-alt text-purple-400 text-xl"></i>
            </div>
            <h4 class="text-lg font-semibold text-white mb-2">Competitor Analysis</h4>
            <p class="text-slate-400 text-sm mb-4">Track and compare competitor performance metrics and trends.</p>
            <div class="flex items-center text-purple-400 text-sm font-medium">
                <span>Launch Tool</span>
                <i class="fas fa-arrow-right ml-2"></i>
            </div>
        </a>
        
        <!-- Script Helper -->
        <a href="/script-helper" class="card p-6 hover:border-orange-500 transition-colors group">
            <div class="w-12 h-12 bg-orange-600/10 rounded-lg flex items-center justify-center mb-4 group-hover:bg-orange-600/20 transition-colors">
                <i class="fas fa-edit text-orange-400 text-xl"></i>
            </div>
            <h4 class="text-lg font-semibold text-white mb-2">Content Generator</h4>
            <p class="text-slate-400 text-sm mb-4">Generate optimized content scripts using AI assistance.</p>
            <div class="flex items-center text-orange-400 text-sm font-medium">
                <span>Launch Tool</span>
                <i class="fas fa-arrow-right ml-2"></i>
            </div>
        </a>
        
        <!-- Smart Calendar -->
        <a href="/smart-calendar" class="card p-6 hover:border-emerald-500 transition-colors group">
            <div class="w-12 h-12 bg-emerald-600/10 rounded-lg flex items-center justify-center mb-4 group-hover:bg-emerald-600/20 transition-colors">
                <i class="fas fa-calendar-alt text-emerald-400 text-xl"></i>
            </div>
            <h4 class="text-lg font-semibold text-white mb-2">Smart Calendar</h4>
            <p class="text-slate-400 text-sm mb-4">AI-powered content scheduling for optimal engagement timing.</p>
            <div class="flex items-center text-emerald-400 text-sm font-medium">
                <span>Launch Tool</span>
                <i class="fas fa-arrow-right ml-2"></i>
            </div>
        </a>
    </div>
</div>

<!-- Recent Activity and Quick Actions -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- Recent Activity -->
    <div class="lg:col-span-2 card p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-lg font-semibold text-white">Recent Activity</h3>
            <button class="text-blue-400 hover:text-blue-300 text-sm transition-colors">
                View All
            </button>
        </div>
        
        <div class="space-y-4" id="recent-activity">
            {% if recent_analyses %}
                {% for analysis in recent_analyses %}
                <div class="flex items-center p-3 rounded-lg bg-slate-800/50 border border-slate-700">
                    <div class="w-10 h-10 {{ getTypeColor(analysis.type) }} rounded-lg flex items-center justify-center mr-3">
                        <i class="{{ getTypeIcon(analysis.type) }} text-white"></i>
                    </div>
                    <div class="flex-1">
                        <p class="text-white font-medium text-sm">{{ analysis.title }}</p>
                        <p class="text-slate-400 text-xs">{{ analysis.type.replace('_', ' ').title() }} - {{ analysis.created_at[:16] }}</p>
                    </div>
                    {% if analysis.video_url %}
                    <a href="{{ analysis.video_url }}" target="_blank" class="text-blue-400 hover:text-blue-300 text-xs">
                        <i class="fas fa-external-link-alt"></i>
                    </a>
                    {% endif %}
                </div>
                {% endfor %}
            {% else %}
            <div class="text-center py-8">
                <i class="fas fa-chart-bar text-4xl text-slate-600 mb-4"></i>
                <p class="text-slate-400 mb-4">No recent activity</p>
                <p class="text-slate-500 text-sm">Start analyzing your content to see activity here</p>
            </div>
            {% endif %}
        </div>
    </div>
    
    <!-- Channel Insights (if connected) or Quick Actions -->
    <div class="card p-6">
        {% if user and user.channel_verified %}
        <h3 class="text-lg font-semibold text-white mb-4">Channel Insights</h3>
        <div class="space-y-4">
            <div class="p-4 rounded-lg bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/30">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-blue-300 font-medium text-sm">Growth Rate</span>
                    <span class="text-green-400 text-sm">+12.3%</span>
                </div>
                <p class="text-slate-400 text-xs">Your subscriber growth this month</p>
            </div>
            
            <div class="p-4 rounded-lg bg-gradient-to-r from-green-500/10 to-emerald-500/10 border border-green-500/30">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-green-300 font-medium text-sm">Engagement</span>
                    <span class="text-green-400 text-sm">4.7%</span>
                </div>
                <p class="text-slate-400 text-xs">Average engagement rate</p>
            </div>
            
            <div class="p-4 rounded-lg bg-gradient-to-r from-purple-500/10 to-pink-500/10 border border-purple-500/30">
                <div class="flex items-center justify-between mb-2">
                    <span class="text-purple-300 font-medium text-sm">Sentiment</span>
                    <span class="text-green-400 text-sm">85% Positive</span>
                </div>
                <p class="text-slate-400 text-xs">Overall audience sentiment</p>
            </div>
        </div>
        
        <div class="mt-6 pt-4 border-t border-slate-600">
            <h4 class="text-sm font-medium text-white mb-3">Quick Actions</h4>
            <div class="space-y-2">
                <button onclick="window.location.href='/my-channel'" class="w-full p-2 rounded bg-red-500/20 text-red-300 hover:bg-red-500/30 transition-colors text-left text-xs">
                    <i class="fab fa-youtube mr-2"></i>
                    View Channel Dashboard
                </button>
                <button onclick="refreshChannelData()" class="w-full p-2 rounded bg-blue-500/20 text-blue-300 hover:bg-blue-500/30 transition-colors text-left text-xs">
                    <i class="fas fa-sync-alt mr-2"></i>
                    Refresh Channel Data
                </button>
            </div>
        </div>
        {% else %}
        <h3 class="text-lg font-semibold text-white mb-4">Quick Actions</h3>
        <div class="space-y-3">
            <button onclick="window.location.href='/sentiment-analyzer'" class="w-full p-3 rounded-lg bg-blue-600/10 border border-blue-600/20 text-blue-400 hover:bg-blue-600/20 transition-colors text-left text-sm">
                <i class="fas fa-plus mr-3"></i>
                New Analysis
            </button>
            <button onclick="window.location.href='/smart-calendar'" class="w-full p-3 rounded-lg bg-emerald-600/10 border border-emerald-600/20 text-emerald-400 hover:bg-emerald-600/20 transition-colors text-left text-sm">
                <i class="fas fa-calendar-plus mr-3"></i>
                Create Calendar
            </button>
            <button class="w-full p-3 rounded-lg bg-slate-700/50 border border-slate-600 text-slate-300 hover:bg-slate-700 transition-colors text-left text-sm">
                <i class="fas fa-download mr-3"></i>
                Export Reports
            </button>
            <button class="w-full p-3 rounded-lg bg-slate-700/50 border border-slate-600 text-slate-300 hover:bg-slate-700 transition-colors text-left text-sm">
                <i class="fas fa-calendar mr-3"></i>
                Schedule Analysis
            </button>
            
            {% if not user or not user.channel_verified %}
            <div class="mt-4 p-3 rounded-lg bg-red-500/10 border border-red-500/30">
                <h5 class="text-red-300 font-medium text-sm mb-2">Connect Your Channel</h5>
                <p class="text-red-200 text-xs mb-3">Connect your YouTube channel for enhanced analytics and automatic transcript import.</p>
                <button onclick="window.location.href='/my-channel'" class="w-full p-2 bg-red-500/20 text-red-300 rounded hover:bg-red-500/30 transition-colors text-xs">
                    <i class="fab fa-youtube mr-2"></i>
                    Connect Channel
                </button>
            </div>
            {% endif %}
        </div>
        {% endif %}
        
        <div class="mt-6 pt-4 border-t border-slate-600">
            <h4 class="text-sm font-medium text-white mb-3">System Status</h4>
            <div class="space-y-2">
                <div class="flex items-center justify-between text-xs">
                    <span class="text-slate-400">API Connections</span>
                    <span class="text-green-400 flex items-center">
                        <div class="w-2 h-2 bg-green-400 rounded-full mr-1"></div>
                        Online
                    </span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="text-slate-400">Data Processing</span>
                    <span class="text-green-400 flex items-center">
                        <div class="w-2 h-2 bg-green-400 rounded-full mr-1"></div>
                        Active
                    </span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="text-slate-400">YouTube Integration</span>
                    <span class="{% if user and user.channel_verified %}text-green-400{% else %}text-yellow-400{% endif %} flex items-center">
                        <div class="w-2 h-2 {% if user and user.channel_verified %}bg-green-400{% else %}bg-yellow-400{% endif %} rounded-full mr-1"></div>
                        {% if user and user.channel_verified %}Connected{% else %}Available{% endif %}
                    </span>
                </div>
                <div class="flex items-center justify-between text-xs">
                    <span class="text-slate-400">Last Updated</span>
                    <span class="text-slate-400">2 min ago</span>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadDashboardStats();
    setupQuickActions();
});

async function loadDashboardStats() {
    try {
        const response = await fetch('/api/dashboard-stats');
        if (response.ok) {
            const stats = await response.json();
            
            // Update metrics
            document.getElementById('total-analyses').textContent = stats.total_analyses || 0;
            
            // Update analysis breakdown
            const analysisTypes = stats.analyses_by_type || {};
            let totalComments = 0;
            Object.values(analysisTypes).forEach(count => {
                totalComments += count * 25; // Estimate comments per analysis
            });
            
            document.getElementById('comments-processed').textContent = formatNumber(totalComments);
            document.getElementById('scripts-generated').textContent = analysisTypes.script || 0;
            
            // Calculate average sentiment (mock calculation)
            const sentimentAnalyses = analysisTypes.sentiment || 0;
            const avgSentiment = sentimentAnalyses > 0 ? (73.2 + Math.random() * 10).toFixed(1) : '0.0';
            document.getElementById('avg-sentiment').textContent = avgSentiment + '%';
        }
    } catch (error) {
        console.error('Error loading dashboard stats:', error);
    }
}

function setupQuickActions() {
    // Add hover animations to tool cards
    const toolCards = document.querySelectorAll('.card');
    toolCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
        });
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateY(0)';
        });
    });
}

async function analyzeLatestVideo() {
    try {
        const response = await fetch('/api/my-videos');
        if (response.ok) {
            const data = await response.json();
            if (data.videos && data.videos.length > 0) {
                const latestVideo = data.videos[0];
                const videoUrl = `https://youtube.com/watch?v=${latestVideo.video_id}`;
                sessionStorage.setItem('preload_video_url', videoUrl);
                window.location.href = '/sentiment-analyzer';
            } else {
                showNotification('No videos found in your channel', 'info');
            }
        }
    } catch (error) {
        showNotification('Failed to get latest video', 'error');
    }
}

function generateContentIdeas() {
    window.location.href = '/script-helper';
}

function createContentCalendar() {
    window.location.href = '/smart-calendar';
}

async function refreshChannelData() {
    try {
        const response = await fetch('/api/refresh-channel-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            showNotification('Channel data refreshed successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            const data = await response.json();
            showNotification(data.error || 'Failed to refresh channel data', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    }
}

function formatNumber(num) {
    if (num >= 1000000) {
        return (num / 1000000).toFixed(1) + 'M';
    } else if (num >= 1000) {
        return (num / 1000).toFixed(1) + 'K';
    }
    return num.toString();
}

function showNotification(message, type = 'info') {
    if (window.showNotification) {
        window.showNotification(message, type);
    } else {
        alert(message); // Fallback
    }
}
</script>
{% endblock %}

<!-- File Location: templates/index.html (REPLACE existing index.html) -->