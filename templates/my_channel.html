{% extends "base.html" %}

{% block title %}My Channel - Alice Insight Suite{% endblock %}
{% block header %}My YouTube Channel{% endblock %}
{% block subtitle %}Manage your channel data, videos, and transcripts{% endblock %}

{% block content %}
<!-- Channel Overview -->
{% if user and user.channel_verified %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
    <!-- Channel Info Card -->
    <div class="lg:col-span-2 card p-8">
        <div class="flex items-start justify-between mb-6">
            <div class="flex items-center">
                <div class="w-16 h-16 rounded-xl overflow-hidden mr-4">
                    {% if user.channel_thumbnail %}
                    <img src="{{ user.channel_thumbnail }}" alt="Channel Thumbnail" class="w-full h-full object-cover">
                    {% else %}
                    <div class="w-full h-full bg-red-500/20 flex items-center justify-center">
                        <i class="fab fa-youtube text-red-400 text-2xl"></i>
                    </div>
                    {% endif %}
                </div>
                <div>
                    <h3 class="text-2xl font-semibold text-white mb-1">{{ user.channel_name or 'Your Channel' }}</h3>
                    <p class="text-slate-400 text-sm">
                        <i class="fas fa-check-circle text-green-400 mr-1"></i>
                        Verified Channel
                    </p>
                </div>
            </div>
            <div class="flex space-x-2">
                <button id="refresh-channel" class="w-10 h-10 rounded-lg bg-blue-500/20 flex items-center justify-center text-blue-400 hover:bg-blue-500/30 transition-colors duration-200" title="Refresh channel data">
                    <i class="fas fa-sync-alt"></i>
                </button>
                <a href="{{ user.channel_url }}" target="_blank" class="w-10 h-10 rounded-lg bg-red-500/20 flex items-center justify-center text-red-400 hover:bg-red-500/30 transition-colors duration-200" title="View on YouTube">
                    <i class="fab fa-youtube"></i>
                </a>
            </div>
        </div>
        
        <!-- Channel Stats -->
        <div class="grid grid-cols-3 gap-6">
            <div class="text-center p-4 rounded-lg bg-slate-700/30">
                <div class="text-2xl font-bold text-white mb-1">{{ "{:,}".format(user.channel_subscriber_count) if user.channel_subscriber_count else '0' }}</div>
                <div class="text-slate-400 text-sm">Subscribers</div>
            </div>
            <div class="text-center p-4 rounded-lg bg-slate-700/30">
                <div class="text-2xl font-bold text-white mb-1">{{ user.channel_video_count or '0' }}</div>
                <div class="text-slate-400 text-sm">Videos</div>
            </div>
            <div class="text-center p-4 rounded-lg bg-slate-700/30">
                <div class="text-2xl font-bold text-white mb-1">{{ "{:,}".format(user.channel_view_count) if user.channel_view_count else '0' }}</div>
                <div class="text-slate-400 text-sm">Total Views</div>
            </div>
        </div>
        
        <!-- Channel Description -->
        {% if user.channel_description %}
        <div class="mt-6 p-4 rounded-lg bg-slate-700/30">
            <h4 class="text-white font-medium mb-2">About</h4>
            <p class="text-slate-300 text-sm leading-relaxed">{{ user.channel_description[:200] }}{% if user.channel_description|length > 200 %}...{% endif %}</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Quick Actions -->
    <div class="space-y-6">
        <!-- Channel Analytics -->
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-white mb-4">
                <i class="fas fa-chart-line text-blue-400 mr-2"></i>
                Quick Analytics
            </h3>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-3 rounded-lg bg-slate-700/30">
                    <span class="text-slate-300 text-sm">Videos Imported</span>
                    <span class="text-white font-semibold">{{ user_videos|length }}</span>
                </div>
                <div class="flex justify-between items-center p-3 rounded-lg bg-slate-700/30">
                    <span class="text-slate-300 text-sm">Transcripts Available</span>
                    <span class="text-white font-semibold">{{ user_transcripts|length }}</span>
                </div>
                <div class="flex justify-between items-center p-3 rounded-lg bg-slate-700/30">
                    <span class="text-slate-300 text-sm">Channel Health</span>
                    <span class="text-green-400 font-semibold">
                        <i class="fas fa-heart mr-1"></i>
                        Excellent
                    </span>
                </div>
            </div>
        </div>
        
        <!-- Channel Actions -->
        <div class="card p-6">
            <h3 class="text-lg font-semibold text-white mb-4">
                <i class="fas fa-tools text-emerald-400 mr-2"></i>
                Channel Tools
            </h3>
            <div class="space-y-3">
                <button id="analyze-all-videos" class="w-full p-3 rounded-lg bg-blue-500/10 border border-blue-500/30 text-blue-300 hover:bg-blue-500/20 transition-colors text-left text-sm">
                    <i class="fas fa-chart-pie mr-3"></i>
                    Analyze All Video Sentiments
                </button>
                <button id="generate-content-ideas" class="w-full p-3 rounded-lg bg-purple-500/10 border border-purple-500/30 text-purple-300 hover:bg-purple-500/20 transition-colors text-left text-sm">
                    <i class="fas fa-lightbulb mr-3"></i>
                    Generate Content Ideas
                </button>
                <button id="export-transcripts" class="w-full p-3 rounded-lg bg-green-500/10 border border-green-500/30 text-green-300 hover:bg-green-500/20 transition-colors text-left text-sm">
                    <i class="fas fa-download mr-3"></i>
                    Export All Transcripts
                </button>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- No Channel Connected -->
<div class="card p-8 mb-8 text-center">
    <div class="w-24 h-24 bg-red-500/10 rounded-full flex items-center justify-center mx-auto mb-6">
        <i class="fab fa-youtube text-red-400 text-4xl"></i>
    </div>
    <h3 class="text-2xl font-bold text-white mb-4">Connect Your YouTube Channel</h3>
    <p class="text-slate-400 mb-6">Connect your YouTube channel to import videos, transcripts, and unlock advanced analytics features.</p>
    
    <form id="connect-channel-form" class="max-w-md mx-auto">
        <div class="mb-4">
            <input type="url" id="channel-url-connect" placeholder="https://youtube.com/@yourchannel" 
                   class="w-full p-4 bg-slate-700 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-red-500">
        </div>
        <button type="submit" class="w-full py-3 px-6 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-xl transition-colors">
            <i class="fab fa-youtube mr-2"></i>
            Connect Channel
        </button>
    </form>
</div>
{% endif %}

<!-- Videos Grid -->
<div class="mb-8">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-2xl font-bold text-white">Your Videos</h3>
        <div class="flex items-center space-x-4">
            <!-- Filter -->
            <select id="video-filter" class="px-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                <option value="all">All Videos</option>
                <option value="with-transcript">With Transcripts</option>
                <option value="without-transcript">Without Transcripts</option>
                <option value="high-views">High Views</option>
            </select>
            
            <!-- Search -->
            <div class="relative">
                <input type="text" id="video-search" placeholder="Search videos..." 
                       class="pl-10 pr-4 py-2 bg-slate-700 border border-slate-600 rounded-lg text-white placeholder-slate-400 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 w-64">
                <i class="fas fa-search absolute left-3 top-3 text-slate-400 text-sm"></i>
            </div>
        </div>
    </div>
    
    {% if user_videos %}
    <div id="videos-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for video in user_videos %}
        <div class="video-card card overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1" data-video-id="{{ video.video_id }}">
            <!-- Video Thumbnail -->
            <div class="relative aspect-video bg-slate-700">
                {% if video.thumbnail_url %}
                <img src="{{ video.thumbnail_url }}" alt="Video Thumbnail" class="w-full h-full object-cover">
                {% else %}
                <div class="w-full h-full flex items-center justify-center">
                    <i class="fas fa-play-circle text-slate-500 text-4xl"></i>
                </div>
                {% endif %}
                
                <!-- Video Stats Overlay -->
                <div class="absolute bottom-2 right-2">
                    <div class="flex space-x-1">
                        {% set transcript_available = user_transcripts|selectattr("video_id", "equalto", video.video_id)|list %}
                        {% if transcript_available %}
                        <span class="px-2 py-1 bg-green-500/80 text-white text-xs rounded-full">
                            <i class="fas fa-closed-captioning"></i>
                        </span>
                        {% endif %}
                        <span class="px-2 py-1 bg-black/80 text-white text-xs rounded-full">
                            {{ "{:,}".format(video.view_count) if video.view_count else '0' }} views
                        </span>
                    </div>
                </div>
            </div>
            
            <!-- Video Info -->
            <div class="p-4">
                <h4 class="text-white font-medium mb-2 line-clamp-2 leading-tight">{{ video.title }}</h4>
                <div class="flex items-center justify-between text-xs text-slate-400 mb-3">
                    <span>{{ video.published_at[:10] if video.published_at else 'No date' }}</span>
                    <span>{{ video.comment_count or '0' }} comments</span>
                </div>
                
                <!-- Action Buttons -->
                <div class="flex space-x-2">
                    <button onclick="viewVideoDetails('{{ video.video_id }}')" 
                            class="flex-1 px-3 py-2 bg-blue-500/20 text-blue-300 rounded-lg hover:bg-blue-500/30 transition-colors text-xs">
                        <i class="fas fa-eye mr-1"></i>
                        Details
                    </button>
                    <button onclick="analyzeVideo('{{ video.video_id }}')" 
                            class="flex-1 px-3 py-2 bg-green-500/20 text-green-300 rounded-lg hover:bg-green-500/30 transition-colors text-xs">
                        <i class="fas fa-chart-pie mr-1"></i>
                        Analyze
                    </button>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="text-center py-12">
        <i class="fas fa-video text-6xl text-slate-600 mb-4"></i>
        <h4 class="text-xl font-semibold text-white mb-2">No Videos Found</h4>
        {% if user and user.channel_verified %}
        <p class="text-slate-400 mb-6">We couldn't find any videos for your channel. Try refreshing your channel data.</p>
        <button id="refresh-videos" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white font-semibold rounded-lg transition-colors">
            <i class="fas fa-sync-alt mr-2"></i>
            Refresh Videos
        </button>
        {% else %}
        <p class="text-slate-400">Connect your YouTube channel to import your videos and transcripts.</p>
        {% endif %}
    </div>
    {% endif %}
</div>

<!-- Video Details Modal -->
<div id="video-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm hidden flex items-center justify-center z-50">
    <div class="bg-slate-800 rounded-xl max-w-4xl w-full mx-4 max-h-[90vh] overflow-hidden border border-slate-600">
        <div class="p-6 border-b border-slate-600">
            <div class="flex items-center justify-between">
                <h3 class="text-xl font-bold text-white" id="modal-video-title">Video Details</h3>
                <button id="close-video-modal" class="text-slate-400 hover:text-white">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
        </div>
        <div class="p-6 overflow-y-auto max-h-[70vh]" id="modal-video-content">
            <!-- Video details will be loaded here -->
        </div>
        <div class="p-6 border-t border-slate-600 flex justify-end gap-3">
            <button id="view-on-youtube" class="px-4 py-2 bg-red-500/20 text-red-300 rounded-lg hover:bg-red-500/30 transition-colors">
                <i class="fab fa-youtube mr-2"></i>
                View on YouTube
            </button>
            <button id="analyze-video-detailed" class="px-4 py-2 bg-blue-500/20 text-blue-300 rounded-lg hover:bg-blue-500/30 transition-colors">
                <i class="fas fa-chart-pie mr-2"></i>
                Analyze Sentiment
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentVideoId = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    setupEventListeners();
    setupVideoFiltering();
});

function setupEventListeners() {
    // Refresh channel data
    const refreshButton = document.getElementById('refresh-channel');
    if (refreshButton) {
        refreshButton.addEventListener('click', refreshChannelData);
    }
    
    // Connect channel form
    const connectForm = document.getElementById('connect-channel-form');
    if (connectForm) {
        connectForm.addEventListener('submit', connectChannel);
    }
    
    // Modal events
    document.getElementById('close-video-modal').addEventListener('click', closeVideoModal);
    document.getElementById('video-modal').addEventListener('click', function(e) {
        if (e.target === this) closeVideoModal();
    });
    
    // Channel tools
    const analyzeAllBtn = document.getElementById('analyze-all-videos');
    if (analyzeAllBtn) {
        analyzeAllBtn.addEventListener('click', analyzeAllVideos);
    }
    
    const exportTranscriptsBtn = document.getElementById('export-transcripts');
    if (exportTranscriptsBtn) {
        exportTranscriptsBtn.addEventListener('click', exportAllTranscripts);
    }
}

function setupVideoFiltering() {
    const filterSelect = document.getElementById('video-filter');
    const searchInput = document.getElementById('video-search');
    
    if (filterSelect) {
        filterSelect.addEventListener('change', filterVideos);
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', debounce(filterVideos, 300));
    }
}

function filterVideos() {
    const filter = document.getElementById('video-filter')?.value || 'all';
    const searchTerm = document.getElementById('video-search')?.value.toLowerCase() || '';
    const videoCards = document.querySelectorAll('.video-card');
    
    videoCards.forEach(card => {
        const title = card.querySelector('h4').textContent.toLowerCase();
        const hasTranscript = card.querySelector('.fa-closed-captioning') !== null;
        const viewCount = parseInt(card.querySelector('[data-view-count]')?.dataset.viewCount || '0');
        
        let showCard = true;
        
        // Apply filter
        switch (filter) {
            case 'with-transcript':
                showCard = hasTranscript;
                break;
            case 'without-transcript':
                showCard = !hasTranscript;
                break;
            case 'high-views':
                showCard = viewCount > 1000;
                break;
        }
        
        // Apply search
        if (searchTerm && showCard) {
            showCard = title.includes(searchTerm);
        }
        
        card.style.display = showCard ? 'block' : 'none';
    });
}

async function refreshChannelData() {
    const button = document.getElementById('refresh-channel');
    const originalContent = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/refresh-channel-data', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
            showNotification('Channel data refreshed successfully!', 'success');
            setTimeout(() => location.reload(), 1000);
        } else {
            const data = await response.json();
            showNotification(data.error || 'Failed to refresh channel data', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    } finally {
        button.innerHTML = originalContent;
        button.disabled = false;
    }
}

async function connectChannel(e) {
    e.preventDefault();
    
    const channelUrl = document.getElementById('channel-url-connect').value;
    const button = e.target.querySelector('button[type="submit"]');
    const originalContent = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Connecting...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/verify-channel', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ channel_url: channelUrl })
        });
        
        const data = await response.json();
        
        if (response.ok) {
            showNotification('Channel connected successfully!', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showNotification(data.error || 'Failed to connect channel', 'error');
        }
    } catch (error) {
        showNotification('Network error. Please try again.', 'error');
    } finally {
        button.innerHTML = originalContent;
        button.disabled = false;
    }
}

function viewVideoDetails(videoId) {
    currentVideoId = videoId;
    
    // Find video data (this would typically come from an API call)
    const videoCard = document.querySelector(`[data-video-id="${videoId}"]`);
    const title = videoCard.querySelector('h4').textContent;
    
    document.getElementById('modal-video-title').textContent = title;
    document.getElementById('modal-video-content').innerHTML = `
        <div class="space-y-6">
            <div class="aspect-video bg-slate-700 rounded-lg flex items-center justify-center">
                <i class="fas fa-play-circle text-6xl text-slate-500"></i>
            </div>
            <div>
                <h4 class="text-white font-medium mb-2">Video Information</h4>
                <div class="grid grid-cols-2 gap-4 text-sm">
                    <div class="p-3 rounded-lg bg-slate-700/30">
                        <span class="text-slate-400">Video ID:</span>
                        <span class="text-white ml-2 font-mono">${videoId}</span>
                    </div>
                    <div class="p-3 rounded-lg bg-slate-700/30">
                        <span class="text-slate-400">Status:</span>
                        <span class="text-green-400 ml-2">Published</span>
                    </div>
                </div>
            </div>
            <div id="transcript-section">
                <h4 class="text-white font-medium mb-2">Transcript</h4>
                <div class="p-4 rounded-lg bg-slate-700/30">
                    <p class="text-slate-300 text-sm">Loading transcript...</p>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('video-modal').classList.remove('hidden');
    
    // Load transcript
    loadVideoTranscript(videoId);
}

async function loadVideoTranscript(videoId) {
    try {
        const response = await fetch(`/api/video-transcript/${videoId}`);
        const transcriptSection = document.getElementById('transcript-section');
        
        if (response.ok) {
            const data = await response.json();
            transcriptSection.innerHTML = `
                <h4 class="text-white font-medium mb-2">Transcript</h4>
                <div class="p-4 rounded-lg bg-slate-700/30 max-h-60 overflow-y-auto">
                    <p class="text-slate-300 text-sm leading-relaxed">${data.transcript_text}</p>
                </div>
                <div class="mt-2 text-xs text-slate-400">
                    Language: ${data.language} • ${data.auto_generated ? 'Auto-generated' : 'Manual'}
                </div>
            `;
        } else {
            transcriptSection.innerHTML = `
                <h4 class="text-white font-medium mb-2">Transcript</h4>
                <div class="p-4 rounded-lg bg-red-500/10 border border-red-500/30">
                    <p class="text-red-300 text-sm">Transcript not available for this video.</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading transcript:', error);
    }
}

function closeVideoModal() {
    document.getElementById('video-modal').classList.add('hidden');
    currentVideoId = null;
}

function analyzeVideo(videoId) {
    // Redirect to sentiment analyzer with this video
    const videoUrl = `https://youtube.com/watch?v=${videoId}`;
    sessionStorage.setItem('preload_video_url', videoUrl);
    window.location.href = '/sentiment-analyzer';
}

async function analyzeAllVideos() {
    const button = document.getElementById('analyze-all-videos');
    const originalContent = button.innerHTML;
    
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-3"></i>Analyzing...';
    button.disabled = true;
    
    try {
        // This would typically trigger bulk analysis
        await new Promise(resolve => setTimeout(resolve, 3000)); // Simulate processing
        showNotification('All videos queued for sentiment analysis!', 'success');
    } catch (error) {
        showNotification('Failed to start bulk analysis', 'error');
    } finally {
        button.innerHTML = originalContent;
        button.disabled = false;
    }
}

async function exportAllTranscripts() {
    try {
        const response = await fetch('/api/my-videos');
        if (!response.ok) throw new Error('Failed to fetch videos');
        
        const data = await response.json();
        
        // Create CSV content
        let csvContent = 'Video ID,Title,Published Date,Transcript\n';
        
        for (const video of data.videos) {
            try {
                const transcriptResponse = await fetch(`/api/video-transcript/${video.video_id}`);
                let transcript = 'No transcript available';
                
                if (transcriptResponse.ok) {
                    const transcriptData = await transcriptResponse.json();
                    transcript = transcriptData.transcript_text.replace(/"/g, '""'); // Escape quotes
                }
                
                csvContent += `"${video.video_id}","${video.title.replace(/"/g, '""')}","${video.published_at}","${transcript}"\n`;
            } catch (error) {
                console.error(`Error getting transcript for ${video.video_id}:`, error);
            }
        }
        
        // Download CSV
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `channel_transcripts_${new Date().toISOString().slice(0, 10)}.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        showNotification('Transcripts exported successfully!', 'success');
    } catch (error) {
        showNotification('Failed to export transcripts', 'error');
    }
}

function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

function showNotification(message, type = 'info') {
    // Use global notification system if available
    if (window.showNotification) {
        window.showNotification(message, type);
    } else {
        alert(message); // Fallback
    }
}
</script>
{% endblock %}

<!-- File Location: templates/my_channel.html (NEW FILE) -->