{% extends "base.html" %}

{% block title %}Sentiment Analyzer{% endblock %}
{% block header %}Sentiment Analyzer{% endblock %}
{% block subtitle %}Discover the emotional pulse of your audience{% endblock %}

{% block content %}
<!-- Input Section -->
<div class="card p-8 mb-8">
    <div class="flex items-center mb-6">
        <div class="w-12 h-12 rounded-xl bg-blue-500/20 flex items-center justify-center mr-4">
            <i class="fas fa-chart-pie text-blue-400 text-xl"></i>
        </div>
        <div>
            <h3 class="text-2xl font-semibold text-white">Video Analysis</h3>
            <p class="text-slate-400">Enter a YouTube URL to analyze comment sentiment and emotions</p>
        </div>
    </div>
    
    <form id="sentiment-form" class="api-form">
        <div class="flex flex-col md:flex-row gap-4">
            <div class="flex-1">
                <label for="video-url" class="block text-lg font-medium text-white mb-3">YouTube Video URL</label>
                <div class="relative">
                    <input type="url" id="video-url" 
                           class="w-full p-4 pl-12 bg-slate-800/50 border border-slate-600 rounded-xl text-white placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-blue-500" 
                           placeholder="https://www.youtube.com/watch?v=..." required>
                    <i class="fas fa-link absolute left-4 top-5 text-slate-400"></i>
                </div>
            </div>
            <div class="flex items-end">
                <button type="submit" 
                        class="btn-primary px-8 py-4 rounded-xl text-white font-semibold hover:shadow-lg flex items-center">
                    <span id="analyze-button-text">Analyze Sentiment</span>
                    <i id="analyze-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i>
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Results Section -->
<div id="results" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
        <div class="card p-6">
            <h3 class="text-xl font-semibold text-white mb-4">Sentiment Breakdown</h3>
            <div class="relative h-64"><canvas id="sentimentChart"></canvas></div>
            <div id="sentiment-summary" class="mt-4 p-4 rounded-lg bg-slate-700/30 text-slate-300 text-sm"></div>
        </div>
        
        <div class="card p-6">
            <h3 class="text-xl font-semibold text-white mb-4">Emotion Analysis</h3>
            <div class="relative h-64"><canvas id="emotionChart"></canvas></div>
            <div id="emotion-summary" class="mt-4 p-4 rounded-lg bg-slate-700/30 text-slate-300 text-sm"></div>
        </div>
    </div>
    
    <div class="card p-6">
        <h3 class="text-lg font-semibold text-white mb-4"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i>AI Recommendations</h3>
        <div id="recommendations" class="space-y-3 text-sm text-slate-300"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let sentimentChartInstance, emotionChartInstance;
Chart.defaults.color = '#94a3b8';

document.getElementById('sentiment-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    const videoUrl = document.getElementById('video-url').value;
    const resultsDiv = document.getElementById('results');
    const analyzeButton = document.querySelector('#sentiment-form button[type="submit"]');
    
    resultsDiv.classList.add('hidden');
    analyzeButton.disabled = true;
    analyzeButton.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i>Analyzing...`;
    
    try {
        const response = await fetch('/api/analyze-sentiment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ video_url: videoUrl })
        });
        
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.error || 'Analysis failed.');
        }
        
        resultsDiv.classList.remove('hidden');
        renderSentimentChart(data.sentiment_data);
        renderEmotionChart(data.emotion_data);
        generateRecommendations(data);

        if (data.from_cache) {
            window.showNotification("Loaded cached results from the last 24 hours.", "info", { duration: 4000 });
        } else {
            window.showNotification("Sentiment analysis complete!", "success");
        }
        
    } catch (error) {
        window.showNotification(error.message, 'error');
    } finally {
        analyzeButton.disabled = false;
        analyzeButton.innerHTML = `<span>Analyze Sentiment</span>`;
    }
});

function renderSentimentChart(data) {
    const ctx = document.getElementById('sentimentChart').getContext('2d');
    if (sentimentChartInstance) sentimentChartInstance.destroy();
    
    const total = data.positive + data.neutral + data.negative;
    sentimentChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Positive', 'Neutral', 'Negative'],
            datasets: [{
                data: [data.positive, data.neutral, data.negative],
                backgroundColor: ['#10b981', '#64748b', '#ef4444'],
                borderColor: '#0f172a',
                borderWidth: 4
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    
    document.getElementById('sentiment-summary').textContent = `Overall, ${(total > 0 ? (data.positive / total * 100) : 0).toFixed(1)}% of comments were positive.`;
}

function renderEmotionChart(data) {
    const ctx = document.getElementById('emotionChart').getContext('2d');
    if (emotionChartInstance) emotionChartInstance.destroy();

    const emotionColors = { joy: '#facc15', sadness: '#3b82f6', anger: '#dc2626', surprise: '#9333ea', fear: '#4b5563', disgust: '#db2777' };
    const labels = Object.keys(data);
    const values = Object.values(data);
    
    emotionChartInstance = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: labels.map(l => l.charAt(0).toUpperCase() + l.slice(1)),
            datasets: [{
                data: values,
                backgroundColor: labels.map(l => emotionColors[l] + '80'),
                borderColor: labels.map(l => emotionColors[l]),
                borderWidth: 2
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
    
    if (labels.length > 0 && values.length > 0) {
        const dominantEmotion = labels[values.indexOf(Math.max(...values))];
        document.getElementById('emotion-summary').textContent = `The dominant emotion detected was ${dominantEmotion}, indicating a strong emotional response from viewers.`;
    } else {
        document.getElementById('emotion-summary').textContent = 'No dominant emotion could be determined.';
    }
}

function generateRecommendations(data) {
    const recsContainer = document.getElementById('recommendations');
    let recs = [];
    const { sentiment_data, emotion_data } = data;
    const total = sentiment_data.positive + sentiment_data.neutral + sentiment_data.negative;

    if (total === 0) {
        recs.push('Not enough data to generate recommendations. Try a video with more comments.');
    } else {
        if (sentiment_data.positive / total > 0.7) {
            recs.push('Excellent positive sentiment! Your content is resonating well. Create more content in this style.');
        } else if (sentiment_data.negative / total > 0.2) {
            recs.push('Negative sentiment is higher than average. Review negative comments to identify and address common pain points.');
        } else {
            recs.push('A balanced sentiment profile. Look for ways to convert neutral comments to positive ones by asking engaging questions.');
        }
        
        const dominantEmotion = Object.keys(emotion_data).reduce((a, b) => emotion_data[a] > emotion_data[b] ? a : b);
        if (dominantEmotion === 'joy') {
            recs.push(`The high level of '<strong>Joy</strong>' is a great sign. Double down on the humor or uplifting aspects of your content.`);
        } else if (dominantEmotion === 'surprise') {
            recs.push(`Viewers are '<strong>Surprised</strong>', which means your content is unpredictable. Use this to your advantage with unexpected twists or reveals.`);
        } else if (dominantEmotion === 'sadness' || dominantEmotion === 'anger') {
            recs.push(`The presence of '<strong>${dominantEmotion}</strong>' suggests you've touched on a sensitive or controversial topic. Handle with care and consider a follow-up to address community feelings.`);
        }
    }

    recsContainer.innerHTML = recs.map(rec => `<p class="flex items-start"><i class="fas fa-check-circle text-green-400 mr-2 mt-1"></i><span>${rec}</span></p>`).join('');
}

// Pre-fill URL from session storage if available
document.addEventListener('DOMContentLoaded', () => {
    const preloadedUrl = sessionStorage.getItem('preload_video_url');
    if (preloadedUrl) {
        document.getElementById('video-url').value = preloadedUrl;
        sessionStorage.removeItem('preload_video_url');
        document.getElementById('sentiment-form').dispatchEvent(new Event('submit'));
    }
});
</script>
{% endblock %}